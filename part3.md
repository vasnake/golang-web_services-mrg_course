# Разработка веб-сервисов на Golang. Часть 3:

- week 1, Структура приложения
- week 2, Проектирование API
- week 3, GraphQL
- week 4, Сборка docker-контейнера, хранение файлов в S3, трейсинг запросов

## part 3, week 1 (09)

Структура приложения
[Код, домашки, литература](week_09/materials.zip) https://cloud.mail.ru/public/GzJG/nccMpqdzQ

### Структурируем приложение - 1 (вводная)

На примере цельного приложения `photolist` рассмотрим несколько важных тем.

### Структурируем приложение - 2 (описание прототипа и его проблем)

- [main](week_09/basic_main.go)
- [photos](week_09/basic_photos.go)

Начнем с прототипа, сляпанного из спагетти-кода. Чтобы сразу нарисовать целостную картину и декларировать проблемы, решаемые в следующих лекциях.

Главная программа, веб-сервис и модуль с утилитами для фоток.
Фунциональность: одна страница, на которой мы можем выбрать фотку для upload и видеть превьюхи уже загруженных фоток.

Три хандлера: `/`-list, `/upload`-upload, `/images/`-static_files.

Проблемы: глобальные переменные, не-потоко-безопасные; постоянный парсинг шаблона; нет авторизации;
файлы на диске сервера (вместо абстрактного хранилища);
вычитывание файлов для каждой превью, прямо при обработке запроса (должно быть через очередь, в воркерах);
код плохо разбит на модули и сложно тестировать.

### Структурируем приложение - 3 (распил на модули)

- [handlers](week_09/storage_handlers.go)
- [main](week_09/storage_main.go)
- [photos](week_09/storage_photos.go)
- [storage](week_09/storage_storage.go)
- [templates](week_09/storage_templates.go)

Разделение приложения на модули (файлы go).
На части разделился main: handlers, storage, templates.

При старте программы создается структура с инициализацией полей Storage, Templates.
Хендлеры страниц реализованы как методы этой структуры и пользуются этими полями, отвечающими некоторому нашему интерфейсу.

Шаблон теперь парсится один раз, при старте программы. Уже лучше.

Функциональность немного абстрагирована, разбита на модули и может быть протестирована.

### Структурируем приложение - 4 (add DB)

- [main](week_09/db_main.go)
- [db_init.sql](week_09/db_db_init.sql)
- [storage](week_09/db_storage.go)

Добавим БД `mysql` для поддержки постоянного хранения метаданных (списка загруженных файлов).
При создании структуры с данными сервиса мы кладем туда реф. на хранилище с тем-же интерфейсом но использующее БД.

Обсудили еще раз проблему глобальных переменных и их инициализации внутри фунции с помощью конструкции `db := createConnect(...)`:
тут не инициализируется глобальная переменная, тут создается новая локальная переменная.

### Тестируем комплексное приложение - 1 (sqlmock)

- [storage_test](week_09/db_storage_test.go)

Как тестировать логику, завязанную на запросы к БД.
Использовать драйвер к `sql.DB`: go-sqlmock.
Мокать запросы к БД.

### Тестируем комплексное приложение - 2 (gomock)

- [handlers](week_09/test_handlers.go)
- [handler_test](week_09/test_handler_test.go)

Как тестировать хендлер веб-страницы на примере `List`.
Сначала посчитали, сколько и каких кейсов тестирования надо: получение фоток (ок, ерр), заполнение шаблона (ок, ерр).
Сообразили, что нужен mock хранилища.

Поэтому: в данных сервиса реф. на хранилище меняем на реф. на интерфейс.
Потом в тесте подкладываем мок хранилища в код сервера и тестируем разные случаи.

По интерфейсу кодогенератор сделает обвязку, `mockgen ...`
В тестах используем её.

Upload handler будем мокать и тестировать тогда, когда абстрагируем хранилище и задействуем облако.

NB: интерфейс должен объявляться в том месте, где будет использоваться (где наиболее общий код).
Кроме случаев с интерфейсами общего назначения.
Почему? Направление зависимости в обратную сторону.
Реализация не должна объявлять этот интерфейс, просто реализовать заявленные методы.

### Авторизация и пароли - 1 (auth MVP)

- [db_init.sql](week_09/auth_db_init.sql)
- [templates](week_09/auth_templates.go)
- [main](week_09/auth_main.go)
- [session](week_09/auth_session.go)
- [index](week_09/auth_index.go)
- [user](week_09/auth_user.go)

Базовая версия подсистемы идентификации-авторизации.

Таблица с сессиями, таблица с пользователями. Для просмотра БД использует веб-морду Adminer.
Регистрация нового пользователя, выдача ему сессии-куки.

Появилась структура UserHandler.
Появились урлы (и хендлеры) login, logout, reg.
Завернул все урлы в AuthMiddleware через `/`.

Потом добавил статику `/images/`, получилось, что картинки отдаются мимо авторизации, ибо при маршрутизации сначала проверится
самый длинный путь (images) и дернется его обработчик, без авторизации.

Мидлварь авторизации проверяет, надо ли требовать наличия пользователя на данной странице.
На некоторых страницах пользователя может и не быть (e.g. регистрация нового пользователя).

Мапка, где значения это пустые структуры `struct{}`, не требует памяти под значения. Это set ключей.
Далее мидлварь достает сессию из БД или создает новую или вываливается с ошибкой.
Сессия добавляется в контекст и дергается downstream обработчик запроса, с передачей ему контекста.

Проверка наличия сессии в контексте используется в главной странице, при решении, куда направить пользователя: на страницу логина или в его ленту.

Обработка логина/регистрации, через БД.
Тонкости проверки/хранения пароля в след.видео.

### Авторизация и пароли - 2 (password hash)

- [user](week_09/auth_user.go)
- [pass](week_09/hashing_pass.go)

Как хешировать и хранить пароль.
Рандомная соль + функция хеширования.
Для одинаковых паролей получаем разные хеши.
Argon2 хорошая функция хеширования.

`hashedPass := argon2.IDKey([]byte(plainPassword), []byte(salt), 1, 64*1024, 4, 32)`

Пример с разными реализациями хеширования пароля.
Бенчмарк по скорости генерации пароля: чем медленнее, тем лучше, затрудняет брут-форс атаки.
Чем больше жрет памяти, тем лучше, труднее запустить на акселераторе.

### CSRF-токены
### Сессии - 1
### Сессии - 2
### Сессии - 3

## part 3, week 2 (10)

Проектирование API
[Код, домашки, литература](week_10/materials.zip) https://cloud.mail.ru/public/bjWY/TfQTzVMer

## part 3, week 3 (11)

GraphQL
[Код, домашки, литература](week_11/materials.zip) https://cloud.mail.ru/public/bjWY/TfQTzVMer

## part 3, week 4 (12)

Сборка docker-контейнера, хранение файлов в S3, трейсинг запросов
[Код, домашки, литература](week_12/materials.zip) https://cloud.mail.ru/public/bjWY/TfQTzVMer
